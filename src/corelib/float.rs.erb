// vim: set ft=rust:
// NOTE: .rs IS AUTO-GENERATED BY .erb
use crate::hir::*;
use crate::corelib::create_method;

<%
# Macro to define binary operator method
def create_bin_method(sig, body)
    ret_type = sig.split(/->\s*/).last
    <<-EOD
    create_method("Float", "#{sig}", |code_gen, function| {
        let this = function.get_params()[0];
        let val1 = code_gen.unbox_float(this);
        let that = function.get_params()[1];
        let val2 = code_gen.unbox_float(that);
        let result = #{body};
        #{
            case ret_type
            when "Bool"
                "let sk_result = code_gen.box_bool(&result);"
            when "Float"
                "let sk_result = code_gen.box_float(&result);"
            else raise
            end
        }
        code_gen.builder.build_return(Some(&sk_result));
        Ok(())
    }),
    EOD
end
%>

pub fn create_methods() -> Vec<SkMethod> {
    vec![

    <%= create_bin_method(
          "==(other: Float) -> Bool",
          'code_gen.builder.build_float_compare(inkwell::FloatPredicate::OEQ, val1, val2, "eq")'
    ) %>

    <%= create_bin_method(
          "!=(other: Float) -> Bool",
          'code_gen.builder.build_float_compare(inkwell::FloatPredicate::UNE, val1, val2, "neq")'
    ) %>

    <%= create_bin_method(
          "<(other: Float) -> Bool",
          'code_gen.builder.build_float_compare(inkwell::FloatPredicate::OLT, val1, val2, "lt")'
    ) %>

    <%= create_bin_method(
          ">(other: Float) -> Bool",
          'code_gen.builder.build_float_compare(inkwell::FloatPredicate::OGT, val1, val2, "gt")'
    ) %>

    <%= create_bin_method(
          "<=(other: Float) -> Bool",
          'code_gen.builder.build_float_compare(inkwell::FloatPredicate::OLE, val1, val2, "leq")'
    ) %>

    <%= create_bin_method(
          ">=(other: Float) -> Bool",
          'code_gen.builder.build_float_compare(inkwell::FloatPredicate::OGE, val1, val2, "geq")'
    ) %>

    <%= create_bin_method(
          "+(other: Float) -> Float",
          'code_gen.builder.build_float_add(val1, val2, "add")'
    ) %>

    <%= create_bin_method(
          "-(other: Float) -> Float",
          'code_gen.builder.build_float_sub(val1, val2, "sub")'
    ) %>

    <%= create_bin_method(
          "*(other: Float) -> Float",
          'code_gen.builder.build_float_mul(val1, val2, "mul")'
    ) %>

    <%= create_bin_method(
          "/(other: Float) -> Float",
          'code_gen.builder.build_float_div(val1, val2, "div")'
    ) %>

    create_method("Float", "abs -> Float", |code_gen, function| {
        let this = function.get_params()[0];
        let x = code_gen.unbox_float(this);
        let func = code_gen.module.get_function("fabs").unwrap();
        let result = code_gen.builder.build_call(func, &[x.into()], "result").try_as_basic_value().left().unwrap();
        let sk_result = code_gen.box_float(&result.into_float_value());
        code_gen.builder.build_return(Some(&sk_result));
        Ok(())
    }),

    create_method("Float", "floor -> Float", |code_gen, function| {
        let this = function.get_params()[0];
        let x = code_gen.unbox_float(this);
        let func = code_gen.module.get_function("floor").unwrap();
        let result = code_gen.builder.build_call(func, &[x.into()], "result").try_as_basic_value().left().unwrap();
        let sk_result = code_gen.box_float(&result.into_float_value());
        code_gen.builder.build_return(Some(&sk_result));
        Ok(())
    }),

    create_method("Float", "to_i() -> Int", |code_gen, function| {
        let this = function.get_params()[0];
        let float = code_gen.unbox_float(this);
        let int = code_gen.builder.build_float_to_signed_int(float, code_gen.i32_type, "int");
        let sk_int = code_gen.box_int(&int);
        code_gen.builder.build_return(Some(&sk_int));
        Ok(())
    }),

    create_method("Float", "-@ -> Float", |code_gen, function| {
        let this = function.get_params()[0];
        let float = code_gen.unbox_float(this);
        let zero = code_gen.f64_type.const_float(0.0);
        let result = code_gen.builder.build_float_sub(zero, float, "result");
        let sk_result = code_gen.box_float(&result);
        code_gen.builder.build_return(Some(&sk_result));
        Ok(())
    }),

    ]
}
